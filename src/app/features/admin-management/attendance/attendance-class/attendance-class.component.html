<div class="container mx-auto p-4">
    <!-- Title Section -->
    <div class="flex items-center justify-start mb-4">
        <h1 class="text-2xl font-bold">Manage Student Attendance</h1>
        <small class="px-4 pb-2 text-gray-400 text-sm" *ngIf="classDetails && classDetails.course && schedules.length > 0">
            {{ classDetails?.className }} - {{ classDetails.course?.courseName }} -
            ({{ schedules[0].startDate | date: 'dd-MM-yyyy' }} - {{ schedules[schedules.length - 1].endDate | date: 'dd-MM-yyyy' }})
        </small>
    </div>

    <!-- Table Container -->
    <div class="relative overflow-auto max-h-[calc(100vh-200px)]">
        <table class="min-w-full table-fixed bg-white border">
            <thead class="sticky top-0 bg-gray-200 z-10">
                <!-- Header Row 1: Student Information -->
                <tr class="text-left text-xs font-bold text-gray-600 uppercase">
                    <th class="py-3 px-4" colspan="5">Student Information</th>
                    <th class="py-3 px-4" [attr.colspan]="schedules.length * 2">Session Attendance Data</th>
                </tr>
                <!-- Header Row 2: Columns for Student Info -->
                <tr class="text-left text-xs font-bold text-gray-600 uppercase">
                    <th class="py-3 px-4 w-1/5">Name</th>
                    <th class="py-3 px-4 w-1/5">Class</th>
                    <th class="py-3 px-4 w-1/5">Module</th>
                    <th class="py-3 px-4 w-1/5">Status</th>
                    <th class="py-3 px-4 w-1/5">Type</th>

                    <!-- Session Attendance Header -->
                    <ng-container *ngFor="let schedule of schedules; let i = index">
                        <th class="py-3 px-4 text-center bg-gray-200" colspan="2">
                            Session {{ i + 1 }}<br>{{ schedule.startDate | date: 'dd/MM/yyyy' }}
                        </th>
                    </ng-container>
                </tr>
                <!-- Header Row 3: Ca 1 and Ca 2 Columns -->
                <tr class="text-left text-xs font-bold text-gray-600 uppercase">
                    <th colspan="5" class="py-3 px-4"></th> <!-- Empty cells to align Ca headers with attendance -->
                    <ng-container *ngFor="let schedule of schedules">
                        <th class="py-3 px-4 text-center bg-gray-200">SchoolShift 1</th>
                        <th class="py-3 px-4 text-center bg-gray-200">SchoolShift 2</th>
                    </ng-container>
                </tr>
            </thead>

            <!-- Table Body -->
            <tbody *ngIf="students && students.length > 0">
                <tr *ngFor="let student of students" class="bg-white border-b" [ngClass]="{ 'line-through': student.status !== 'STUDYING' }">
                    <!-- Student Information Columns -->
                    <td class="px-4 py-2">{{ student.fullName }}</td>
                    <td class="px-4 py-2">{{ classDetails.className }}</td>
                    <td class="px-4 py-2">{{ classDetails.sem }}</td>
                    <td class="px-4 py-2">
                        <span class="rounded px-2 py-1 text-xs text-white" [ngClass]="{
                            'bg-green-500': student.status === 'STUDYING',
                            'bg-yellow-500': student.status === 'DELAY',
                            'bg-red-500': student.status === 'DROPPED',
                            'bg-orange-500': student.status === 'GRADUATED'
                        }">
                            {{ student.status }}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <span class="bg-green-500 text-white rounded px-2 py-1 text-xs">Official</span>
                    </td>

                    <!-- Session Attendance Data -->
                    <ng-container *ngFor="let schedule of schedules">
                        <!-- Attendance for Ca 1 -->
                        <td class="relative px-1">
                            <button class="bg-gray-200 p-2 rounded-md w-full text-center" [ngClass]="{
                                'bg-green-500': getAttendanceStatus1(student.userId, schedule.id) === 'P',
                                'bg-orange-500': getAttendanceStatus1(student.userId, schedule.id) === 'PA',
                                'bg-red-500': getAttendanceStatus1(student.userId, schedule.id) === 'A',
                                'bg-gray-200': !getAttendanceStatus1(student.userId, schedule.id)
                            }" (click)="toggleDropdown(student.userId, schedule.id, 'ca1')">
                                <span *ngIf="getAttendanceStatus1(student.userId, schedule.id); else iconTemplate">
                                    {{ getAttendanceStatus1(student.userId, schedule.id) }}
                                </span>
                                <ng-template #iconTemplate>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </ng-template>
                            </button>

                            <div *ngIf="isDropdownOpenCheck(student.userId, schedule.id, 'ca1')" class="absolute z-10 bg-white shadow-md border mt-1 rounded-md w-40">
                                <ul class="py-1">
                                    <li *ngFor="let status of ['P', 'A', 'PA']"
                                        (click)="selectStatus(student.userId, schedule.id, status, true)"
                                        [class.bg-gray-300]="getAttendanceStatus1(student.userId, schedule.id) === status"
                                        class="px-4 py-2 cursor-pointer hover:bg-gray-200">
                                        {{ status }}
                                    </li>
                                    <li class="px-4 py-2 cursor-pointer hover:bg-gray-200 border-t"
                                        (click)="openCommentDialog(student.userId, schedule.id)">
                                        Add Comment
                                    </li>
                                </ul>
                            </div>
                        </td>

                        <!-- Attendance for Ca 2 -->
                        <td class="relative px-1">
                            <button class="bg-gray-200 p-2 rounded-md w-full text-center" [ngClass]="{
                                'bg-green-500': getAttendanceStatus2(student.userId, schedule.id) === 'P',
                                'bg-orange-500': getAttendanceStatus2(student.userId, schedule.id) === 'PA',
                                'bg-red-500': getAttendanceStatus2(student.userId, schedule.id) === 'A',
                                'bg-gray-200': !getAttendanceStatus2(student.userId, schedule.id)
                            }" (click)="toggleDropdown(student.userId, schedule.id, 'ca2')">
                                <span *ngIf="getAttendanceStatus2(student.userId, schedule.id); else iconTemplate">
                                    {{ getAttendanceStatus2(student.userId, schedule.id) }}
                                </span>
                                <ng-template #iconTemplate>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </ng-template>
                            </button>

                            <div *ngIf="isDropdownOpenCheck(student.userId, schedule.id, 'ca2')" class="absolute z-10 bg-white shadow-md border mt-1 rounded-md w-40">
                                <ul class="py-1">
                                    <li *ngFor="let status of ['P', 'A', 'PA']"
                                        (click)="selectStatus(student.userId, schedule.id, status, false)"
                                        [class.bg-gray-300]="getAttendanceStatus2(student.userId, schedule.id) === status"
                                        class="px-4 py-2 cursor-pointer hover:bg-gray-200">
                                        {{ status }}
                                    </li>
                                    <li class="px-4 py-2 cursor-pointer hover:bg-gray-200 border-t"
                                        (click)="openCommentDialog(student.userId, schedule.id)">
                                        Add Comment
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </ng-container>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Message for no students -->
    <div *ngIf="students.length === 0" class="text-center py-4 text-gray-600">No students available.</div>
</div>
